<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Oghma Node Demo</title>

    <!-- jQuery and jQuery Mobile -->
    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="js/jquery.mobile-1.4.4.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/high/highcharts.js"></script>
    <script src="js/high/modules/exporting.js"></script>

    <!-- css file for mobile devices -->
    <LINK href="js/jquery.mobile-1.4.4.min.css" rel="stylesheet" type="text/css">

    <!-- Code for socket.io and device orientation handling -->
    <script>
        var socket = io.connect();
        var datalog = [];
        var all_data = [];
        var chart;
        var myVar = setInterval(function(){readDatafromB()},1000);

        var series;
        var latest_data;
        var time_interval;
        var current_time;
        var motion=true;
        time_interval=100;
        current_time=-1000;
        var status='stop';

        function start_stop(){
            if (status=='stop')
            {
                status='readData';
                window.clearInterval(myVar);
                socket.emit('initialize','false');
                socket.emit('start_data_collection','true',time_interval);
                $("#tabs").tabs("option", "active", 1);

            }else if(status =='readData')
            {
                status='stop'
            }
        }

        socket.on('1stsensorvalue', function (data) {
            console.log(data);
            //$("#data1").val(data);
            $("#data1").html("<b>"+data+"</b>  mBar");
            latest_data = data;
            datalog.push({
                x: current_time,
                y: data
            });
            if(current_time>=0)
            {
                var table = document.getElementById("data_table");
                var row = table.insertRow(-1);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                cell1.innerHTML = current_time;
                cell2.innerHTML = "<b>"+data+"</b>";
            }

        });

        socket.on('sensors',function(sensors)
        {//get list of sensors at stop
            var current_sensor_array = sensors.split(',');
            var i;

            for (i = 0; i < current_sensor_array.length; i++) {
                if (current_sensor_array[i]!='')
                {
                    var split_sensor_array = current_sensor_array[i].split(':');

                    //checking PORT1
                    if (split_sensor_array[0]=="port1")
                    {
                        if(split_sensor_array[1]=="pressure")
                        {
                            $("#datasouce-1").show();
                            $("#sensorname1").html("Pressure Sensor");
                            $("#sensor_value1").html(split_sensor_array[2]);
                        }else if(split_sensor_array[1]=="temp")
                        {
                            $("#datasouce-1").show();
                            $("#sensorname1").html("Temperature Sensor");
                            $("#sensor_value1").html(split_sensor_array[2]);
                        }else{
                            $("#datasouce-1").hide();
                            $("#sensorname1").html(" ");
                        }
                    }

                    //checking PORT2
                    if (split_sensor_array[0]=="port2")
                    {
                        if(split_sensor_array[1]=="pressure")
                        {
                            $("#datasouce-2").show();
                            $("#sensorname2").html("Pressure Sensor");
                            $("#sensor_value2").html(split_sensor_array[2]);
                        }else if(split_sensor_array[1]=="temp")
                        {
                            $("#datasouce-2").show();
                            $("#sensorname2").html("Temperature Sensor");
                            $("#sensor_value2").html(split_sensor_array[2]);
                        }else{
                            $("#datasouce-2").hide();
                            $("#sensorname2").html(" ");
                        }
                    }

                    //checking PORT3
                    if (split_sensor_array[0]=="port3")
                    {
                        if(split_sensor_array[1]=="pressure")
                        {
                            $("#datasouce-3").show();
                            $("#sensorname3").html("Pressure Sensor");
                            $("#sensor_value3").html(split_sensor_array[2]);
                        }else if(split_sensor_array[1]=="temp")
                        {
                            $("#datasouce-3").show();
                            $("#sensorname3").html("Temperature Sensor");
                            $("#sensor_value3").html(split_sensor_array[2]);
                        }else{
                            $("#datasouce-3").hide();
                            $("#sensorname3").html(" ");
                        }
                    }

                }

            }

        });

        function readDatafromB(){
            socket.emit('initialize','true');
        }

        $(function () {
            $(document).ready(function() {

                //hiding unused elements at first
                $("#data_table").hide();
                $("#datasouce-1").hide();
                $("#datasouce-2").hide();
                $("#datasouce-3").hide();
                $("#datasouce-4").hide();

                $("#tabs").tabs();

                Highcharts.setOptions({
                    global: {
                        useUTC: false
                    }
                });

                var chart;
                $('#container').highcharts({
                    chart: {
                        zoomType: 'x',
                        spacingRight: 20,
                        animation: Highcharts.svg, // don't animate in old IE
                        marginRight: 10,
                        events: {
                            load: function() {

                                // set up the updating of the chart each second
                                var series = this.series[0];
                                setInterval(function() {
                                    current_time = current_time+100, // current time
                                            series.addPoint([current_time, latest_data], true, true);
                                }, 100);
                            }
                        }
                    },
                    title: {
                        text: 'Pressure Data'
                    },

                    xAxis: {
                        tickPixelInterval: 150
                    },
                    yAxis: {
                        title: {
                            text: 'mBar'
                        },
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    },
                    tooltip: {
                        formatter: function() {
                            return '<b>'+ this.series.name +'</b><br/>'+
                                    Highcharts.numberFormat(this.y, 2); +', '+
                            Highcharts.numberFormat(this.x, 2);
                        }
                    },
                    legend: {
                        enabled: true
                    },
                    exporting: {
                        enabled: true
                    },
                    series: [{
                        name: 'Pressure Reading',
                        data: (function() {
                            // generate an array of random data
                            var data = [],
                                    time = (new Date()).getTime(),
                                    i;

                            for (i = -50; i <= 0; i++) {
                                data.push({
                                    x: current_time,
                                    y: latest_data
                                });
                            }
                            console.log(data);
                            return data;
                        })()
                    }]
                });
            });

        });


    </script>
</head>
<body onload="readDatafromB();" >
<!-- Home -->
<div data-role="page" id="page1">
    <div data-theme="a" data-role="header">
        <h3>
            Oghma Systems
        </h3>
    </div>
    <div data-role="content">
        <div data-role="fieldcontain">

           <!-- Data: <span id="data1" name="data1" data-theme="b"></span>-->
        </div>
        <!-- <div data-role="fieldcontain">
             <label for="datarate">
                 Data Rate:
             </label>
             <input id="datarate" type="input" name="datarate" value="0" min="0" max="100"
             data-highlight="false" data-theme="b"><input type="button" id="data_rate" value="Change">
         </div>-->
        <input type="button" id="start_stop_button" value="Start Data Collection" onclick="start_stop();">
        <!--<input type="button" id="show_hide_button" value="Show Table" onclick="show_hide_div();">
        <div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        <div data-role="fieldcontain">
            <table id="data_table" name="datarate" data-theme="b">
                <tr>
                    <th> Time </th>
                    <th> Pressure </th>
                </tr>
            </table>
        </div>-->

        <div data-role="tabs" id="tabs">
            <div data-role="navbar">
                <ul>
                    <li><a href="#one" data-ajax="false">Reading</a></li>
                    <li><a href="#two" data-ajax="false">Graphics</a></li>
                    <li><a href="#three" data-ajax="false">Table</a></li>
                </ul>
            </div>
            <div id="one" class="ui-body-d ui-content">
                <div id="datasouce-1" style="background-color: darkred;color: whitesmoke;height: 150px;padding: 5px;">
                    PORT1 : <span id="sensorname1" name="sensorname1"></span><br/>
                    <span id="sensor_value1" name="sensor_value1" style="font-size: 100px"></span>
                </div>
                <div id="datasouce-2" style="background-color: darkslategray;color: whitesmoke;height: 150px; padding: 5px;">
                    PORT2 : <span id="sensorname2" name="sensorname2"></span><br/>
                    <span id="sensor_value2" name="sensor_value1" style="font-size: 100px"></span>
                </div>
                <div id="datasouce-3" style="background-color: darkblue;color: whitesmoke;height: 150px;padding: 5px;">
                    PORT3 : <span id="sensorname3" name="sensorname3"></span><br/>
                    <span id="sensor_value3" name="sensor_value1" style="font-size: 100px"></span>
                </div>
                <div id="datasouce-4" style="background-color: darkmagenta;color: whitesmoke;height: 150px;padding: 5px;">
                    DIGI : <span id="diginame" name="diginame"></span><br/>
                    <span id="digi_value" name="digi_value" style="font-size: large"></span>
                </div>
            </div>
            <div id="two">
                <div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
            </div>
            <div id="three">
               <p>Hullo!</p>
            </div>
        </div>

    </div>
</div>
</body>
</html>